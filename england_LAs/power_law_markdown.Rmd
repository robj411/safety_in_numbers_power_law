---
title: "Road traffic injuries: regression and power law"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)
library(stringr)
library(dplyr)
setwd('~/overflow_dropbox/safety_in_numbers_power_law/england_LAs/')

summary_counts <- readRDS('data/england_power_law_data.Rds')

car_mod <- glm(log(Car)~log(Pedal.Cycles),data=summary_counts)
summary_counts$logcarpred <- car_mod$fitted.values
summary_counts$logcarresidual <- log(summary_counts$Car) - summary_counts$logcarpred

rural_percent_threshold <- 0.02
urban <- subset(summary_counts,ruralpercent<rural_percent_threshold)
rural <- subset(summary_counts,ruralpercent>=rural_percent_threshold)
datasets <- list(all=summary_counts,urban=urban,rural=rural)
inj_cols <- c('whw_bike','whw_ksi_bike','whw_fatal_bike')
ylabs <- c('injuries','KSI','fatalities')
hist(summary_counts$ruralpercent,breaks=50)
```

# Data

First let's look at the basic log-log relationship between number of cyclist injuries and distance travelled (over 11 years and across 148 areas).

These plots are descriptive: we're expecting to see a positive correlation, i.e. the more cycling there is, the more injuries to cyclists there are.

```{r basic}
par(mfrow=c(1,3))
for(i in 1:3) plot(log(summary_counts$Pedal.Cycles),log(summary_counts[[inj_cols[i]]]),pch=16,col='navyblue',xlab='Distance cycled',ylab=paste0('Cyclist ',ylabs[i]))
```



And now let's look at the difference between all the areas and the urban areas (in pink).

Note that in general the areas of urban have a higher rate. This might be because they are more dense.

```{r urban}
par(mfrow=c(1,3))
for(i in 1:3) {
  plot(log(summary_counts$Pedal.Cycles),log(summary_counts[[inj_cols[i]]]),pch=16,col='navyblue',xlab='Distance cycled',ylab=paste0('Cyclist ',ylabs[i]))
  points(log(urban$Pedal.Cycles),log(urban[[inj_cols[i]]]),pch=16,col='hotpink')
}
```


And now let's look at the rates (the numbers per distance travelled).

These plots should be more diagnostic: we should expect to see a negative correlation if the more cycling there is, the fewer injuries there are per cyclist.

Note that there are fewer events for serious injuries and fewer still fatalities. This results in the straight diagonal lines, and indicate that the definition of rate is not useful here.

```{r rate}
par(mfrow=c(1,3))
for(i in 1:3) plot(log(summary_counts$Pedal.Cycles),log(summary_counts[[inj_cols[i]]]/summary_counts$Pedal.Cycles),pch=16,col='navyblue',xlab='Distance cycled',ylab=paste0('Cyclist ',ylabs[i],' per distance cycled'))
```




```{r urban rate}
par(mfrow=c(1,3))
for(i in 1:3) {
  plot(log(summary_counts$Pedal.Cycles),log(summary_counts[[inj_cols[i]]]/summary_counts$Pedal.Cycles),pch=16,col='navyblue',xlab='Distance cycled',ylab=paste0('Cyclist ',ylabs[i],' per distance cycled'))
  points(log(urban$Pedal.Cycles),log(urban[[inj_cols[i]]]/urban$Pedal.Cycles),pch=16,col='hotpink')
}
```



# Analysis : numbers

### Cycle distance only as a predictor, for all, urban and rural, for all, ksi, and fatal.

```{r coefficient: one predictor}
coef_summary <- data.frame(all=c(),urban=c(),rural=c())
for(j in 1:3)
  for(i in 1:3){
    frml <- paste0(inj_cols[i],'~log(Pedal.Cycles)')
    mod <- glm(as.formula(frml),data=datasets[[j]],family=poisson(),offset=log(Pedal.Cycles))
    coef_summary[i,j] <- mod$coefficients[2]+1
  }
rownames(coef_summary) <- ylabs
colnames(coef_summary) <- names(datasets)
coef_summary
```


### Cycle distance and motor distance as predictors, for all, urban and rural, for all, ksi, and fatal.

All: 
```{r 2 coefficients: all}
coef_summary <- data.frame(pedal=c(),motor=c(),sum=c())
  for(i in 1:3){
    frml <- paste0(inj_cols[i],'~log(Pedal.Cycles)+log(All.Motor.Vehicles)')
    mod <- glm(as.formula(frml),data=datasets[[1]],family=poisson(),offset=log(Pedal.Cycles)+log(All.Motor.Vehicles))
    coef_summary[i,1:2] <- mod$coefficients[2:3]+1
    coef_summary[i,3] <- sum(coef_summary[i,1:2])
  }
rownames(coef_summary) <- ylabs
colnames(coef_summary) <- c('pedal','motor','sum')
coef_summary
```

Urban: 

```{r 2 coefficients: urban}
coef_summary <- data.frame(pedal=c(),motor=c(),sum=c())
  for(i in 1:3){
    frml <- paste0(inj_cols[i],'~log(Pedal.Cycles)+log(All.Motor.Vehicles)')
    mod <- glm(as.formula(frml),data=datasets[[2]],family=poisson(),offset=log(Pedal.Cycles)+log(All.Motor.Vehicles))
    coef_summary[i,1:2] <- mod$coefficients[2:3]+1
    coef_summary[i,3] <- sum(coef_summary[i,1:2])
  }
rownames(coef_summary) <- ylabs
colnames(coef_summary) <- c('pedal','motor','sum')
coef_summary
```

Rural: 

```{r 2 coefficients: rural}
coef_summary <- data.frame(pedal=c(),motor=c(),sum=c())
  for(i in 1:3){
    frml <- paste0(inj_cols[i],'~log(Pedal.Cycles)+log(All.Motor.Vehicles)')
    mod <- glm(as.formula(frml),data=datasets[[3]],family=poisson(),offset=log(Pedal.Cycles)+log(All.Motor.Vehicles))
    coef_summary[i,1:2] <- mod$coefficients[2:3]+1
    coef_summary[i,3] <- sum(coef_summary[i,1:2])
  }
rownames(coef_summary) <- ylabs
colnames(coef_summary) <- c('pedal','motor','sum')
coef_summary
```

### Cycle distance and car residual distance as predictors, for all, urban and rural, for all, ksi, and fatal.

Here we used the residual car travel - that is, the amount more or less than we expected based on cycle travel.

All:
```{r coefficients with residual: all}
coef_summary <- data.frame(pedal=c(),motor=c())
  for(i in 1:3){
    frml <- paste0(inj_cols[i],'~log(Pedal.Cycles)+logcarresidual')
    mod <- glm(as.formula(frml),data=datasets[[1]],family=poisson(),offset=log(Pedal.Cycles)+logcarresidual)
    coef_summary[i,1:2] <- mod$coefficients[2:3]+1
  }
rownames(coef_summary) <- ylabs
colnames(coef_summary) <- c('pedal','motor residual')
coef_summary
```

Urban:

```{r coefficients with residual: urban}
coef_summary <- data.frame(pedal=c(),motor=c())
  for(i in 1:3){
    frml <- paste0(inj_cols[i],'~log(Pedal.Cycles)+logcarresidual')
    mod <- glm(as.formula(frml),data=datasets[[2]],family=poisson(),offset=log(Pedal.Cycles)+logcarresidual)
    coef_summary[i,1:2] <- mod$coefficients[2:3]+1
  }
rownames(coef_summary) <- ylabs
colnames(coef_summary) <- c('pedal','motor residual')
coef_summary
```

Rural:

```{r coefficients with residual: rural}
coef_summary <- data.frame(pedal=c(),motor=c())
  for(i in 1:3){
    frml <- paste0(inj_cols[i],'~log(Pedal.Cycles)+logcarresidual')
    mod <- glm(as.formula(frml),data=datasets[[3]],family=poisson(),offset=log(Pedal.Cycles)+logcarresidual)
    coef_summary[i,1:2] <- mod$coefficients[2:3]+1
  }
rownames(coef_summary) <- ylabs
colnames(coef_summary) <- c('pedal','motor residual')
coef_summary
```


### Area name, cycle distance and motor distance as predictors, for all, urban and rural, for all, ksi, and fatal.

Using three predictors. Here it starts to go quite wrong. We get negative values. We might do better if we could supply priors.

All:

```{r 3 coefficients: all}
coef_summary <- data.frame(pedal=c(),motor=c(),sum=c())
  for(i in 1:3){
    frml <- paste0(inj_cols[i],'~log(Pedal.Cycles)+log(All.Motor.Vehicles)+LA_Name')
    mod <- glm(as.formula(frml),data=datasets[[1]],family=poisson(),offset=log(Pedal.Cycles)+log(All.Motor.Vehicles))
    coef_summary[i,1:2] <- mod$coefficients[2:3]+1
    coef_summary[i,3] <- sum(coef_summary[i,1:2])
  }
rownames(coef_summary) <- ylabs
colnames(coef_summary) <- c('pedal','motor','sum')
coef_summary
```

Urban:

```{r 3 coefficients: urban}
coef_summary <- data.frame(pedal=c(),motor=c(),sum=c())
  for(i in 1:3){
    frml <- paste0(inj_cols[i],'~log(Pedal.Cycles)+log(All.Motor.Vehicles)+LA_Name')
    mod <- glm(as.formula(frml),data=datasets[[2]],family=poisson(),offset=log(Pedal.Cycles)+log(All.Motor.Vehicles))
    coef_summary[i,1:2] <- mod$coefficients[2:3]+1
    coef_summary[i,3] <- sum(coef_summary[i,1:2])
  }
rownames(coef_summary) <- ylabs
colnames(coef_summary) <- c('pedal','motor','sum')
coef_summary
```

Rural:

```{r 3 coefficients: rural}
coef_summary <- data.frame(pedal=c(),motor=c(),sum=c())
  for(i in 1:3){
    frml <- paste0(inj_cols[i],'~log(Pedal.Cycles)+log(All.Motor.Vehicles)+LA_Name')
    mod <- glm(as.formula(frml),data=datasets[[3]],family=poisson(),offset=log(Pedal.Cycles)+log(All.Motor.Vehicles))
    coef_summary[i,1:2] <- mod$coefficients[2:3]+1
    coef_summary[i,3] <- sum(coef_summary[i,1:2])
  }
rownames(coef_summary) <- ylabs
colnames(coef_summary) <- c('pedal','motor','sum')
coef_summary
```


# Analysis : density

### Cycle road distance density and motor road distance density as predictors, for all, urban and rural, for all, ksi, and fatal.

All:

```{r coefficients: all}
coef_summary <- data.frame(pedal=c(),motor=c(),sum=c())
  for(i in 1:3){
    frml <- paste0(inj_cols[i],'~log(cyclist_density)+log(motor_density)')
    mod <- glm(as.formula(frml),data=datasets[[1]],family=poisson(),offset=log(cyclist_density)+log(motor_density)+log(AB))
    coef_summary[i,1:2] <- mod$coefficients[2:3]+1
    coef_summary[i,3] <- sum(coef_summary[i,1:2])
  }
rownames(coef_summary) <- ylabs
colnames(coef_summary) <- c('pedal','motor','sum')
coef_summary
```

Urban:

```{r coefficients: urban}
coef_summary <- data.frame(pedal=c(),motor=c(),sum=c())
  for(i in 1:3){
    frml <- paste0(inj_cols[i],'~log(cyclist_density)+log(motor_density)')
    mod <- glm(as.formula(frml),data=datasets[[2]],family=poisson(),offset=log(cyclist_density)+log(motor_density)+log(AB))
    coef_summary[i,1:2] <- mod$coefficients[2:3]+1
    coef_summary[i,3] <- sum(coef_summary[i,1:2])
  }
rownames(coef_summary) <- ylabs
colnames(coef_summary) <- c('pedal','motor','sum')
coef_summary
```

Rural:

```{r coefficients: rural}
coef_summary <- data.frame(pedal=c(),motor=c(),sum=c())
  for(i in 1:3){
    frml <- paste0(inj_cols[i],'~log(cyclist_density)+log(motor_density)')
    mod <- glm(as.formula(frml),data=datasets[[3]],family=poisson(),offset=log(cyclist_density)+log(motor_density)+log(AB))
    coef_summary[i,1:2] <- mod$coefficients[2:3]+1
    coef_summary[i,3] <- sum(coef_summary[i,1:2])
  }
rownames(coef_summary) <- ylabs
colnames(coef_summary) <- c('pedal','motor','sum')
coef_summary
```

# Visualisation : density

There doesn't seem to be a clear relationship between density and injury, given our implementation of density as the total travel divided by the total road length.

```{r urban density rate}
par(mfrow=c(1,3))
for(i in 1:3){
  plot(log(summary_counts$Pedal.Cycles/summary_counts$AB),log(summary_counts[[inj_cols[i]]]/summary_counts$Pedal.Cycles),pch=16,col='navyblue',xlab='Cycle distance density',ylab=paste0('Cyclist ',ylabs[i],' per distance cycled'))
  points(log(urban$Pedal.Cycles/urban$AB),log(urban[[inj_cols[i]]]/urban$Pedal.Cycles),pch=16,col='hotpink')
}
```


```{r urban density number}
par(mfrow=c(1,3))
for(i in 1:3){
  plot(log(summary_counts$Pedal.Cycles/summary_counts$AB),log(summary_counts[[inj_cols[i]]]),pch=16,col='navyblue',xlab='Cycle distance density',ylab=paste0('Cyclist ',ylabs[i]))
  points(log(urban$Pedal.Cycles/urban$AB),log(urban[[inj_cols[i]]]),pch=16,col='hotpink')
}
```